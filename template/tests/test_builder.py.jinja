"""Tests for the docset builder.

These tests cover universal Dash docset functionality.
Add site-specific tests as you customize the builder.
"""

import re
from urllib.parse import quote

import pytest


class TestDashAnchorFormat:
    """Test Dash anchor name format - universal for all docsets."""

    def test_anchor_format(self):
        """Anchor names follow Apple's format."""
        entry_type = "Section"
        name = "Getting Started"
        encoded_name = quote(name, safe="")
        anchor_name = f"//apple_ref/cpp/{entry_type}/{encoded_name}"
        assert anchor_name == "//apple_ref/cpp/Section/Getting%20Started"

    def test_spaces_encoded(self):
        """Spaces are URL-encoded."""
        name = "Hello World"
        encoded = quote(name, safe="")
        assert encoded == "Hello%20World"

    def test_special_characters_encoded(self):
        """Special characters are URL-encoded."""
        name = "C++ & Python"
        encoded = quote(name, safe="")
        assert encoded == "C%2B%2B%20%26%20Python"


class TestAnalyticsRemoval:
    """Test analytics script removal patterns."""

    @pytest.fixture
    def gtm_pattern(self):
        return re.compile(
            r"<script[^>]*googletagmanager[^>]*>.*?</script>",
            re.DOTALL | re.IGNORECASE,
        )

    @pytest.fixture
    def ga_pattern(self):
        return re.compile(
            r"<script[^>]*google-analytics[^>]*>.*?</script>",
            re.DOTALL | re.IGNORECASE,
        )

    def test_gtm_script_detected(self, gtm_pattern):
        html = '<script src="https://www.googletagmanager.com/gtag/js"></script>'
        assert gtm_pattern.search(html)

    def test_ga_script_detected(self, ga_pattern):
        html = '<script src="https://www.google-analytics.com/analytics.js"></script>'
        assert ga_pattern.search(html)

    def test_normal_script_not_detected(self, gtm_pattern, ga_pattern):
        html = '<script src="/js/app.js"></script>'
        assert not gtm_pattern.search(html)
        assert not ga_pattern.search(html)


# TODO: Add site-specific tests here as you customize the builder
# Example:
# class TestNavbarRemoval:
#     """Test navbar removal for your specific site."""
#     pass
